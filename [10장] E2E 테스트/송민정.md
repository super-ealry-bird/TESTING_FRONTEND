# Chapter 10. E2E 테스트

## 10.1 E2E 테스트란
> 프론트엔드에서 E2E 테스트는 브라우저를 사용할 수 있기에 실제 애플리케이션에 가까운 테스트 가능
> 브라우저 고유의 API 를 사용하는 상황이나 화면을 이동하며 테스트하는 상황에 적합

- 브라우저 고유 기능과 연도된 UI 테스트
- 데이터베이스 및 하위 시스템과 연동된 E2E 테스트


⭐️ 무엇을 테스트할지 목적을 명확히 세우기 > **전체 구조에서 얼마나 실제와 유사한 상황을 재현할 것인지가 중요한 기준점** ⭐️ 

<br/>

### 10.1.1 브라우저 고유 기능과 연동한 UI 테스트
> 화면 간의 이동 / 화면 크기를 측정해서 실행되는 로직 / CSS의 미디어 쿼리를 사용한 반응형 처리 / 스크롤 위치에 따른 이벤트 발생 / 쿠키나 로컬 저장소등에 데이터를 저장
>
> 과 같은 상황에서는 jsdom 에서 제대로 테스트 할 수 없다!

💡 상황에 따라 브라우저로 실제 상황과 최대한 유사하게 테스트하고 싶을 때는 **UI 테스트** 를 하면 된다.

- API 서버, 하위 시스템은 목 서버를 만들어 E2E 테스트 프레임워크에서 연동된 기능을 검증 > **피처 테스트**

<br/>

### 10.1.2 데이터베이스 및 서브 시스템과 연동한 E2E 테스트
> E2E 테스트 : 데이터베이스 서버나 외부 시스템과 연동한 실제 애플리케이션과 유사하게 재현해 검증하는 테스트

 - 데이터베이스 서버 연동 (데이터 불러오기/저장하기)
 - 외부 저장소 서비스 연동 (이미지 등 업로드)
 - 레디스와 연동 (세션 관리)


| 계층        | 설명                                                |
|-------------|-----------------------------------------------------|
| 표현 계층   | 사용자와 상호작용하는 부분으로, UI나 API 인터페이스를 담당합니다. |
| 응용 계층   | 비즈니스 로직을 처리하며, 표현 계층과 영속 계층을 중재합니다.      |
| 영속 계층   | 데이터를 영구적으로 저장하고 관리하는 계층으로, DB와의 상호작용을 담당합니다. |

💡 표현/응용/영속 계층을 연동하여 검증하므로 실제 상황과 유사성이 높다는 장점이 있지만, 많은 시스템과 연동하기에 실행 시간이 길고, 불안정하다는 단점도 존재한다.

<br/>


### 10.1.3 이번 장에서 다루는 E2E 테스트
> E2E 테스트에 도커 컴포즈를 도입하면 테스트 환경을 실행하고 종료하는것이 편리

- 예제 docker-compose.e2e.yaml 파일을 보면 연동할 데이터베이스 서버, 레디스 서버 관련 코드가 작성되어있다.

<br />

---

<br />

## 10.2 플레이라이트 설치 및 기초
https://github.com/frontend-testing-book-kr/playwright 

> 플레이라이트 : 마이크로소프트가 공개한 E2E 테스트 프레임워크

- 크로스 브라우징 지원
- 디버깅 테스트
- 리포터
- 트레이스 뷰어
- 테스트 코드 생성기


<br/>

### 10.2.1 설치 및 설정
https://github.com/frontend-testing-book-kr/playwright 

<img width="810" alt="스크린샷 2024-09-24 22 46 11" src="https://github.com/user-attachments/assets/9c7bb8e2-414d-44ad-a572-f4b357f10f92">


💡 설치 완료 시 package.json 에 모듈 추가 + 설정 파일 양식, 예제 테스트 코드 생성

<br/>

### 10.2.2 처음 시작하는 E2E 테스트

> [GET STARTED] 버튼을 클릭해서 공식 문서 페이지로 이동할 수 있는지 검증 

```typescript
test("has title", async ({ page }) => {
  await page.goto("https://playwright.dev/"); // 플레이라이트 공식 문서 페이지

  // 페이지 제목에 "Playwright"가 포함됐는지 검증한다.
  await expect(page).toHaveTitle(/Playwright/);
});

test("get started link", async ({ page }) => {
  await page.goto("https://playwright.dev/");

  // "Get started"라는 접근 가능한 이름을 가진 링크를 취득하고, 링크를 클릭한다.
  await page.getByRole("link", { name: "Get started" }).click();

  // 페이지 URL에 "intro"가 포함됐는지 검증한다.
  await expect(page).toHaveURL(/.*intro/);
});
```

<br />

### 10.2.3 로케이터
> 로케이터 : 플레이라이트의 핵심 API > 현재 페이지에서 특정 요소를 가져오는 역할

_1.27.0 버전에는 테스팅 라이브러리로부터 영향을 받은 접근성 기반 로케이터 추가 (all, and, blur, clear, or, pressSequentially)_

💡 테스팅 라이브러리의 쿼리와 마찬가지로 접근성 기반 로케이터를 우선적으로 사용하는 것 권장 ! 

```typescript
test("코드 10-2",async ({ page }) => {
  await page.getByLabel("User Name").fill("John");
  await page.getByLabel("Password").fill("secret-password");
  await page.getByRole("button", { name: "Sign in" }).click(); //접근 가능한 이름으로 버튼 취득 + 클릭
})
```

**테스팅 라이브러리와 다른점**
- 대기 시간의 필요함에 따라 findByRole 구분 필요 없음
- await 로 인터랙션 완료까지 기다린 후 다음 인터랙션 실행하는 방식으로 작동

<br />

### 10.2.4 단언문
> 명시적으로 expect를 import gotj wkrtjd

```typescript
test("Locator를 사용한 단언문 작성법",async ({ page }) => {
  // 특정 문자열을 가진 요소를 취득해서 화면에 보이는 상태인지 검증한다.
  await expect(page.getByText("Welcome, John!")).toBeVisible();
  // 체크박스체크 박스를 취득해서 체크되어 있는지됐는지 검증한다.
  await expect(page.getByRole("checkbox")).toBeChecked();
  // not으로 진릿값을 반전시킨다.
  await expect(page.getByRole("heading")).not.toContainText("some text");
})
```
( jest 와 동일하게 not 을 사용해서 진릿값 반전 )

<br />

```typescript
test("페이지를 사용한 단언문 작성법",async ({ page }) => {
  // 페이지 URL에 "intro"가 포함됐는지 검증한다.
  await expect(page).toHaveURL(/.*intro/);
  // 페이지 제목에 "Playwright"가 포함됐는지 검증한다.
  await expect(page).toHaveTitle(/Playwright/);
})
```
( expect 의 인수에 페이지를 할당하여 검증용 매처를 추천 )

<br />

---

<br />

## 10.3 테스트할 애플리케이션
> 레디스 서버, 데이터베이스 서버, 외부 저장소 서비스와 연동해야 한다.

<br />

### 10.3.1 애플리케이션 개요
> 사용자가 로그인하여 기술 관련 기사를 작성하고 편집하는 애플리케이션
> 
> 다른 사용자가 작성한 기사에 [like] 버튼을 누를 수 있고 회원가입 기능 (X) 로그인한 사용자는 프로필 편집 (O)

1. **Next.js**

   모든 페이지를 서버 사이드 렌더링 (SSR) 으로 렌더링하며 인증된 요청인지 검사
   (만약 로그인하지 않은 상태이면 로그인 화면으로 리다이렉트)
   레디스 서버와 연동하여 세션으로부터 사용자 정보를 취득

2. **프리즈마**

   PostgreSQL (관계형 DB) 를 사용
   Next.js 서버는 객체 관계 매핑 (ORM) 도구로 타입스크립트와 호환성이 좋은 프리즈마 사용
   (이너 조인한 테이블의 응답을 타입 추론으로 획득할 수 있어 타입스크립트 프로젝트에서 인기가 많은 오픈소스)

3. **S3 Client**

   외부 파일 저장소 서비스로는 AWS S3 사용
   로컬 환경에서는 AWS S3 API 와 호환이 가능한 MinIO 사용
   (기사의 메인 및 프로필 이미지를 저장하는 공간으로 활용


<br />

### 10.3.2 로컬 개발 환경 설정 순서

https://github.com/frontend-testing-book-kr/nextjs

```shell
npm i
```

1. **MinIO Client 설치**

   로컬 환경용 S3 인 MinIO 사용
   ```shell
   brew install minio/stable/mc
   ```

2. **도커 컴포즈로 여러 컨테이너 실행하기**

   도커 컴포즈 파일을 사용하여 로컬 환경에서 사용
   ```shell
   docker compose up -d
   ```

   <br />

   도커 컴포즈로 실행한 MinIO 서버에 버킷 생성하기
   ```shell
   sh create-image-bucket.sh
   ```
   
   <br />

   데이터베이스 마이그레이션 후 테스트용 초기 데이터 주입
   ```shell
   npm run prisma:migrate
   ```
   
   <br />

   Next.js 개발서버 실행 (http://localhost:3000/)
   ```shell
   npm run dev
   ```


<br />

---

<br />

## 10.4 개발 환경에서 E2E 테스트 실행하기
> E2E 테스트 실행해보기

<br />

### 10.4.1 E2E 테스트 설정
> 개발 환경에서 E2E 테스트를 실시하려면 빌드된 Next.js 애플리케이션 실행 (docker compose up -d 실행 상태)

```shell
npm run build && npm start
```
<br />

E2E 테스트 이전에 데이터베이스 테스트 데이터 초기화 (테스트 실행 시 데이터가 변경돼 이후 실행하는 테스트에 영향을 미치기 때문에)

```shell
npm run prisma:reset
```

<br />

### 10.4.2 E2E 테스트 실행
> E2E 테스트 실행

```shell
// 초기 설정 사용 시 헤드리스 모드로 E2E 테스트 실행하기에 브라우저는 나타나지 않는다!
npx plawright test
```

💡 테스트 결과를 리포트로 생성하고 싶으면 `npx playwright show-report` 명령어를 통해 `http://localhost:9223/` 에서 확인할 수 있다.

```shell
// 특정 테스트 파일명을 인수로 지정하면 해당 파일에만 테스트 실시
npx playwright test Login.spect.ts
```

<br />

### 10.4.3 플레이라이트 검사 도구를 활용한 디버깅
> 생각한 것과 다르게 테스트가 통과되지 않을 때 **플레이라이트 검사 도구** 로 원인 파악 필요

⭐️ 커맨드에 --debug 옵션을 붙이면 headed 모드로 테스트가 시작된다.

```shell
npx playwright test Login.spec.ts --debug
```

💡 더 자세한 사용 방법이 알고싶다면 ? 공식 문서 참고하기 

<br />

### 10.4.4 도커 컴포즈를 사용하는 E2E 테스트
> 도커 컴포즈를 사용해서 E2E 테스트 실행할 때

```shell
npm run docker:e2e:build && npm run docker:e2e:ci
```

<br />

---

<br />

## 10.5 프리즈마를 활용한 테스트
### 10.5.1 프리즈마 스키마
### 10.5.2 시드 스크립트 등록
### 10.5.3 시드 스크립트 실행 파일
